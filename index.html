<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Blessed MAX</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;font-family:'Segoe UI',sans-serif;background:radial-gradient(circle at top,#1b263b,#0d1b2a 70%);color:#fff;text-align:center;min-height:100vh;overflow-x:hidden;position:relative}
    body::before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><text x='20' y='60' font-size='50' fill='rgba(255,255,255,0.05)'>$</text></svg>");background-size:120px 120px;animation:moveBg 30s linear infinite;z-index:-1}
    @keyframes moveBg{0%{background-position:0 0}100%{background-position:200px 200px}}
    .marquee{width:100%;overflow:hidden;white-space:nowrap;background:rgba(27,38,59,.9);padding:12px 0;font-weight:700;font-size:16px;position:sticky;top:0}
    .marquee span{display:inline-block;padding-left:100%;animation:scroll 12s linear infinite}
    @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
    .container{padding:20px;margin-top:20px}
    .balance{font-size:22px;margin-top:20px;font-weight:700}
    .bet{font-size:13px;color:#bbb;margin-bottom:20px}
    .btn{display:block;margin:15px auto;padding:14px 20px;border-radius:14px;border:none;font-size:17px;font-weight:600;cursor:pointer;background:rgba(30,58,95,.8);color:#fff;width:85%;max-width:340px;transition:all .3s ease;box-shadow:0 4px 12px rgba(0,0,0,.4);backdrop-filter:blur(6px)}
    .btn:hover{background:rgba(44,82,130,.9);transform:translateY(-4px) scale(1.03);box-shadow:0 6px 16px rgba(0,0,0,.5),0 0 12px rgba(0,180,255,.6)}
    h1{font-size:22px;margin-bottom:8px} p{font-size:15px;color:#ddd;margin-top:0}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.7);justify-content:center;align-items:center}
    .modal-content{background:#1b263b;padding:20px;border-radius:16px;max-width:400px;width:90%;text-align:left}
    .modal h2{margin-top:0}
    .modal input{width:100%;padding:12px;border-radius:10px;border:none;margin:10px 0;font-size:16px}
    .close-btn{background:#c0392b;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;float:right}
    .hint{opacity:.85;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="marquee"><span id="marquee-text">üî• –ù–æ–≤–æ—Å—Ç–∏ –æ—Ç Blessed MAX ‚Äî —Å–¥–∞–≤–∞–π –≤ –∞—Ä–µ–Ω–¥—É –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å! üî•</span></div>

  <div class="container">
    <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Blessed MAX</h1>
    <p>–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π, —Å–¥–∞–≤–∞—è —Å–≤–æ–∏ –∞–∫–∫–∞—É–Ω—Ç—ã MAX –≤ –∞—Ä–µ–Ω–¥—É.</p>
    <div class="balance" id="balance">üíµ –ë–∞–ª–∞–Ω—Å: <b>0$</b></div>
    <div class="bet">–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞: 1$</div>
    <button class="btn" onclick="openModal('statsModal')">üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    <button class="btn" onclick="openModal('submitModal')">üì± –°–¥–∞—Ç—å –Ω–æ–º–µ—Ä</button>
    <button class="btn" onclick="openModal('numbersModal')">üî¢ –ú–æ–∏ –Ω–æ–º–µ—Ä–∞</button>
    <div class="hint">–ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram, —á–∞—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ ‚Äî –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Mini App.</div>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="modal" id="statsModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('statsModal')">‚úñ</button>
      <h2>üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
      <p id="stats">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
  </div>

  <!-- –°–¥–∞—Ç—å –Ω–æ–º–µ—Ä -->
  <div class="modal" id="submitModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('submitModal')">‚úñ</button>
      <h2>üì± –°–¥–∞—Ç—å –Ω–æ–º–µ—Ä</h2>
      <input type="text" id="phoneInput" placeholder="+7XXXXXXXXXX" inputmode="numeric" />
      <button class="btn" onclick="submitNumber()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <p id="submitStatus"></p>
    </div>
  </div>

  <!-- –ú–æ–∏ –Ω–æ–º–µ—Ä–∞ -->
  <div class="modal" id="numbersModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal('numbersModal')">‚úñ</button>
      <h2>üî¢ –ú–æ–∏ –Ω–æ–º–µ—Ä–∞</h2>
      <div id="myNumbers">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>

  <script>
    // === –ù–ê–°–¢–†–û–ô–ö–ê –ë–≠–ö–ï–ù–î–ê ===
    // –£–∫–∞–∂–∏ –ø—É–±–ª–∏—á–Ω—ã–π HTTPS URL —Ç–≤–æ–µ–≥–æ Flask-—Å–µ—Ä–≤–µ—Ä–∞:
    const BASE_URL = "https://api.render.com/deploy/srv-d3568me3jp1c73eptg10?key=sYM3v4uOWEA"; // ‚Üê –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π

    // === Telegram Mini App API ===
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      try { tg.ready(); tg.expand(); } catch (e) {}
      const theme = tg.colorScheme;
      if (theme === "light") document.body.style.background = "radial-gradient(circle at top,#324c7a,#0d1b2a 70%)";
    }

    function getUserId() {
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
        return tg.initDataUnsafe.user.id;
      }
      // –§–æ–ª–±—ç–∫ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –≤–Ω–µ Telegram
      const stored = localStorage.getItem("dev_user_id");
      if (stored) return stored;
      const rnd = Math.floor(100000 + Math.random() * 900000);
      localStorage.setItem("dev_user_id", rnd);
      return rnd;
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fetch —Å –∑–∞—â–∏—Ç–æ–π –∏ –ª–æ–≥–∞–º–∏
    async function api(path, opts = {}) {
      const url = BASE_URL + path;
      const defaults = { headers: { "Content-Type": "application/json" } };
      const config = Object.assign({}, defaults, opts);

      try {
        const res = await fetch(url, config);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const ct = res.headers.get("content-type") || "";
        return ct.includes("application/json") ? res.json() : res.text();
      } catch (e) {
        console.error("API error:", e);
        throw e;
      }
    }

    // === UI –ª–æ–≥–∏–∫–∞ ===
    function openModal(id) {
      document.getElementById(id).style.display = "flex";
      if (id === "statsModal") loadStats();
      if (id === "numbersModal") loadNumbers();
    }
    function closeModal(id) {
      document.getElementById(id).style.display = "none";
    }

    // –ë–µ–≥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞
    async function loadMarquee() {
      try {
        const text = await api("/marquee");
        document.getElementById("marquee-text").innerText = typeof text === "string" ? text : (text.text || "‚Äî");
      } catch (_) {}
    }
    setInterval(loadMarquee, 10000);
    loadMarquee();

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    async function loadStats() {
      const userId = getUserId();
      try {
        const data = await api(`/stats?user_id=${encodeURIComponent(userId)}`);
        document.getElementById("stats").innerHTML =
          `üíµ –ë–∞–ª–∞–Ω—Å: ${data.balance}$<br>` +
          `üì± –°–¥–∞–Ω–æ –Ω–æ–º–µ—Ä–æ–≤: ${data.total_numbers}<br>` +
          `‚è≥ –ú–∏–Ω—É—Ç –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ: ${data.total_minutes}`;
        document.getElementById("balance").innerHTML = `üíµ –ë–∞–ª–∞–Ω—Å: <b>${data.balance}$</b>`;
      } catch (e) {
        document.getElementById("stats").innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.";
      }
    }

    // –°–¥–∞—á–∞ –Ω–æ–º–µ—Ä–∞
    async function submitNumber() {
      const phoneEl = document.getElementById("phoneInput");
      const phone = phoneEl.value.replace(/\s+/g, "");

      if (!/^\+7\d{10}$/.test(phone)) {
        document.getElementById("submitStatus").innerText = "‚ö† –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX";
        return;
      }

      const userId = getUserId();
      try {
        const data = await api("/submit_number", {
          method: "POST",
          body: JSON.stringify({ user_id: userId, phone })
        });
        document.getElementById("submitStatus").innerText = data.message || "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.";
        phoneEl.value = "";
      } catch (e) {
        document.getElementById("submitStatus").innerText = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
      }
    }

    // –ú–æ–∏ –Ω–æ–º–µ—Ä–∞
    async function loadNumbers() {
      const userId = getUserId();
      try {
        const data = await api(`/my_numbers?user_id=${encodeURIComponent(userId)}`);
        const list = (data.numbers || []);
        document.getElementById("myNumbers").innerHTML = list.length ? list.join("<br>") : "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤";
      } catch (e) {
        document.getElementById("myNumbers").innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–º–µ—Ä–∞.";
      }
    }
  </script>
</body>
</html>
